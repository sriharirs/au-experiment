<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Cache-control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <title>Face Landmarker</title>

    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link rel="stylesheet" href="./css/styles.css" />
  </head>

  <body>
    <section id="demos" class="invisible">
      <div id="liveView" class="videoView">
        <button id="webcamButton" class="mdc-button mdc-button--raised">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">ENABLE WEBCAM</span>
        </button>
        <button id="glassButton" class="mdc-button mdc-button--raised">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">ENABLE GLASS</span>
        </button>

        <!-- New Save Button -->
        <button id="saveDataButton" class="mdc-button mdc-button--outlined" style="margin-left: 10px;">
          Save All AU Data
        </button>

        <div style="margin: 10px">
          <label for="background">Choose Background:</label>
          <select id="background" autocomplete="off">
            <option value="video">Camera</option>
            <option value="brown">Grey Background</option>
            <option value="image">Choose Image</option>
          </select>
          <input type="file" id="imageUpload" style="visibility: hidden; resize: none" accept="image/*" autocomplete="off" />
        </div>

        <div style="margin: 10px">
          <label style="display: inline-block; vertical-align: middle" for="background">Choose Amplification:</label>
          <input id="amplification" type="number" value="1" autocomplete="off" style="display: inline-block; vertical-align: middle" />
        </div>

        <div style="margin: 10px">
          <label style="display: inline-block; vertical-align: middle" for="background">Choose Action Unit:</label>
          <select id="actionUnits" autocomplete="off"></select>
        </div>

        <div style="display: flex; flex-direction: column; align-items: center">
          <div style="position: relative; width: 100%; height: 100%">
            <video id="webcam" style="width: 100%; height: 100%; object-fit: cover" autoplay playsinline></video>
            <canvas class="output_canvas" id="output_canvas"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"></canvas>
          </div>
          <div id="3dscene" style="margin-top: 2px; width: 100%; height: 100%; min-height: 480px;"></div>
        </div>
      </div>

      <div class="blend-shapes">
        <div class="column">
          <ul class="blend-shapes-list" id="video-blend-shapes-column1"></ul>
        </div>
      </div>
    </section>

    <!-- Include your main script -->
    <script src="./js/main.js" type="module"></script>

    <!-- Custom AU save script -->
    <script>
      const allAUData = {};

      // This should be called from your AU detection logic (e.g., after each AU is evaluated)
      window.recordAU = function (auName, values) {
        allAUData[auName] = values;
      };

      document.getElementById("saveDataButton").addEventListener("click", () => {
        const blob = new Blob([JSON.stringify(allAUData, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "au_data.json";
        a.click();
        URL.revokeObjectURL(url);
      });
    </script>
  </body>
</html>
